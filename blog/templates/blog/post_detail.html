{% extends 'blog/base.html' %}

{% block title %}{{ post.titulo }}{% endblock %}

{% block content %}
    <div class="card mb-4">
        {% if post.imagen_portada %}
            <img src="{{ post.imagen_portada.url }}" class="card-img-top" alt="{{ post.titulo }}" style="max-height: 400px; object-fit: cover;">
        {% endif %}
        <div class="card-body">
            <h1 class="card-title">{{ post.titulo }}</h1>
            <p class="card-text text-muted">
                Por {{ post.autor.username }} el {{ post.fecha_publicacion|date:"d M, Y H:i" }}
                {% if post.categoria %}
                    <span class="badge bg-info text-dark">{{ post.categoria.nombre }}</span>
                {% endif %}
            </p>
            <p class="card-text">{{ post.contenido|linebreaksbr }}</p> {# linebreaksbr convierte saltos de línea en <br> #}

            {% if user.is_authenticated and user == post.autor or user.is_superuser %}
                <a href="{% url 'post_update' post.pk %}" class="btn btn-warning btn-sm me-2">Editar Post</a>
                <a href="{% url 'post_delete' post.pk %}" class="btn btn-danger btn-sm">Eliminar Post</a>
            {% endif %}
        </div>
    </div>

    <hr>

    <h3 class="mb-3">Comentarios ({{ post.comentarios.count }})</h3>
    {% if user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-header">
                Dejar un comentario
            </div>
            <div class="card-body">
                <form id="comment-form">
                    {% csrf_token %} {# ¡Importante para seguridad! #}
                    <div class="mb-3">
                        <textarea class="form-control" id="comment-content" rows="3" placeholder="Escribe tu comentario aquí..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Publicar Comentario</button>
                </form>
            </div>
        </div>
    {% else %}
        <p class="alert alert-info">Debes <a href="{% url 'login' %}">iniciar sesión</a> para poder comentar.</p>
    {% endif %}

    <div id="comments-section">
        {% for comentario in post.comentarios.all %}
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">{{ comentario.autor.username }} - {{ comentario.fecha_creacion|date:"d M, Y H:i" }}</h6>
                    <p class="card-text">{{ comentario.contenido }}</p>
                </div>
            </div>
        {% empty %}
            <p>Aún no hay comentarios. ¡Sé el primero en comentar!</p>
        {% endfor %}
    </div>

{% endblock content %}

{% block extra_js %}
<script>
    document.getElementById('comment-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Evita que el formulario se envíe de forma tradicional

        const content = document.getElementById('comment-content').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "add_comment" post.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Comentario añadido exitosamente!'); // Puedes usar una notificación más bonita
                document.getElementById('comment-content').value = ''; // Limpia el textarea
                // Recargar la página o agregar el comentario dinámicamente
                location.reload(); // Por simplicidad, recargamos la página
            } else {
                alert('Error al añadir comentario: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al enviar el comentario.');
        });
    });
</script>
{% endblock %}